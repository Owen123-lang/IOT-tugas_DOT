<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0;
            background: white;
        }
        .mermaid { 
            text-align: center; 
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="mermaid">
graph TB
    subgraph "Client Layer"
        WebApp[Web Application]
        MobileApp[Mobile App]
        IoTDevice[IoT Device]
    end

    subgraph "API Gateway / Load Balancer"
        LB[Load Balancer]
    end

    subgraph "NestJS Application"
        subgraph "Controllers"
            AuthController[Auth Controller]
            DeviceController[Device Controller]
            TelemetryController[Telemetry Controller]
        end

        subgraph "Services"
            AuthService[Auth Service]
            UserService[User Service]
            DeviceService[Device Service]
            TelemetryService[Telemetry Service]
        end

        subgraph "Guards & Middleware"
            JWTGuard[JWT Auth Guard]
            ValidationPipe[Validation Pipe]
        end
    end

    subgraph "Data Layer"
        PrismaORM[Prisma ORM]
        PostgreSQL[(PostgreSQL Database)]
    end

    subgraph "External Services"
        Swagger[Swagger Documentation]
        PrismaStudio[Prisma Studio]
    end

    %% Authentication Flow
    WebApp --> LB
    MobileApp --> LB
    IoTDevice --> LB
    
    LB --> JWTGuard
    JWTGuard --> ValidationPipe
    ValidationPipe --> AuthController
    ValidationPipe --> DeviceController
    ValidationPipe --> TelemetryController

    %% Controller to Service mappings
    AuthController --> AuthService
    DeviceController --> DeviceService
    TelemetryController --> TelemetryService

    %% Service Dependencies
    AuthService --> UserService
    DeviceService --> UserService
    TelemetryService --> DeviceService

    %% Service to Database
    UserService --> PrismaORM
    DeviceService --> PrismaORM
    TelemetryService --> PrismaORM

    %% Database Connection
    PrismaORM --> PostgreSQL

    %% Documentation Tools
    LB --> Swagger
    PrismaORM --> PrismaStudio
    </div>
    <script>
        mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'default',
            themeVariables: {
                primaryColor: '#007bff',
                primaryTextColor: '#333',
                primaryBorderColor: '#007bff',
                lineColor: '#666',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#e9ecef'
            }
        });
        
        // Add button to download as PNG
        setTimeout(() => {
            const button = document.createElement('button');
            button.textContent = 'Download as PNG';
            button.style.position = 'fixed';
            button.style.bottom = '20px';
            button.style.right = '20px';
            button.style.padding = '12px 24px';
            button.style.backgroundColor = '#007bff';
            button.style.color = 'white';
            button.style.border = 'none';
            button.style.borderRadius = '6px';
            button.style.cursor = 'pointer';
            button.style.fontSize = '14px';
            button.style.fontWeight = 'bold';
            button.style.zIndex = '1000';
            button.style.boxShadow = '0 4px 12px rgba(0,123,255,0.3)';
            
            button.onclick = () => {
                const svg = document.querySelector('.mermaid svg');
                if (svg) {
                    const svgData = new XMLSerializer().serializeToString(svg);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'system-architecture.png';
                            a.click();
                            URL.revokeObjectURL(url);
                        }, 'image/png');
                    };
                    
                    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                }
            };
            
            document.body.appendChild(button);
        }, 1000);
    </script>
</body>
</html>